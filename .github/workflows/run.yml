name: OB 24/7

on:
  schedule:
    # Chạy vào 5h sáng hàng ngày (UTC) để reset
    - cron: '0 5 * * *'
    # Thêm schedule restart sau 5 tiếng để duy trì 24/7
    - cron: '0 10 * * *'  # 10h (5h + 5h)
    - cron: '0 15 * * *'  # 15h (10h + 5h)
    - cron: '0 20 * * *'  # 20h (15h + 5h)
    - cron: '0 1 * * *'   # 1h sáng hôm sau (20h + 5h)
  workflow_dispatch:
  watch:
    types: started

jobs:
  run-ob:
    runs-on: ubuntu-latest
    timeout-minutes: 300 # 5 giờ

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        pip install gdown
        sudo apt-get update && sudo apt-get install -y curl wget unzip

    - name: Download file
      run: |
        FILE_ID="1kmkI5AtdpHrBG4ml-FIO8xHExlKJ81BO"
        gdown "https://drive.google.com/uc?id=${FILE_ID}" -O api
        chmod +x api
        cp api api.backup

    - name: Setup watchdog
      run: |
        cat > watchdog.sh << 'EOF'
        #!/bin/bash
        while true; do
            if ! pgrep -f "./api" > /dev/null; then
                echo "$(date): Program died, restarting..." >> watchdog.log
                ./api >> program.log 2>&1 &
            fi
            sleep 30
        done
        EOF
        chmod +x watchdog.sh

    - name: Run program with watchdog
      run: |
        echo "Starting program at $(date)"
        ./api >> program.log 2>&1 &
        ./watchdog.sh &
        
        # Giữ cho job chạy đến khi hết thời gian
        while true; do
            sleep 60
            echo "$(date): Still running..." >> heartbeat.log
        done
